---
title: "*Supplementary Material 2*"
subtitle: "Fossil Calibration List"
mainfont: Roboto-Regular.ttf
fontsize: 11pt
mainfontoptions: 
  - BoldFont=Roboto-Bold.ttf
  - ItalicFont=Roboto-Italic.ttf
  - BoldItalicFont=Roboto-BoldItalic.ttf
output: 
  bookdown::pdf_document2:
    citation_package: default
    toc: no
    number_sections: no
    fig_caption: yes
    keep_tex: no
    latex_engine: xelatex
    pandoc_args: [ "--csl", "frontiers.csl"]
  bookdown::word_document2:
    pandoc_args: [ "--csl", "frontiers.csl"]
    toc: no
    number_sections: no
    reference_docx: Frontiers_Template_SI.docx
header-includes: 
  - \usepackage{float} # keep figures from floating away
  - \usepackage{booktabs} # need for kable tables
  - \usepackage{colortbl} # need for kable tables
  - \makeatletter\renewcommand*{\fps@figure}{H}\makeatother # keep figures from floating away
  - \usepackage{fancyhdr} # enable header
  - \pagestyle{fancy}  # enable header
  - \fancypagestyle{plain}{\pagestyle{fancy}} # show header on first page
  - \renewcommand{\headrulewidth}{0pt} # delete line beneath header
  - \fancyhead[RE,RO]{Supplementary Material 2} # add header on right side
  - \fancyhead[LO,LE]{} # suppress automatic section header on left side
  - \setlength{\headheight}{13.6pt}
  - \cfoot{\thepage} # footer
editor_options: 
  chunk_output_type: console
params:
  doc_type: manual
---

---
bibliography: 
- `r here::here("ms/si_fossils.bib")`
---

```{r setup-rmd, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, include = FALSE, warning = FALSE, message = FALSE, results = 'hide')
library(glue)
library(gluedown)
library(tidyverse)
library(assertr)
```

```{r load-functions-si-2, eval = params$doc_type == "manual"}
# Load functions (only if running interactively)
source("_targets.R")
```

```{r load-targets-si-2}
# Targets from MS workflow

# Specify path to FTOL cache
# FIXME: change to ftol_cache when ready
ftol_cache <- here::here("working/_targets")

tar_load(
  c(
    con_fossil_calibration_tips,
    fossil_ferns_raw,
    fossil_ferns_all),
  store = ftol_cache,
)

# Targets from MS workflow
tar_load(
  fossil_notes,
  store = here::here("_targets")
)
```

```{r load-captions-si2, cache = FALSE}
# Source captions numbers from MS
# 
# So that caption numbers are in order of appearance in MS

# Run inline code when purling
options(knitr.purl.inline = TRUE)

# Make a temporary file to write out just inline R code from the SI Rmd
temp_file <- tempfile()

# Generate R script including inline R code from the ms Rmd
knitr::purl(here::here("ms/manuscript.Rmd"), output = temp_file)

# Trim this R script down to only functions that define figure and table captions
read_lines(temp_file) %>%
  magrittr::extract(
    str_detect(., "^figure\\(|^table\\(|^s_figure\\(|^s_table\\(|^figure_num\\(|^table_num\\(|^s_figure_num\\(|^s_table_num\\(")
  ) %>%
  unique %>%
  write_lines(temp_file)

# Source the code. This will load the caption functions in the right order.
source(temp_file, local = TRUE)

# Delete the temporary file
fs::file_delete(temp_file)
```

```{r tidy-fossil-data}
# fossil_ferns_raw is read in from Fossils_Ferns.csv directly
# fossil_ferns_all is same, but with clean names by janitor::clean_names()

# Make tibble of fossil data categories
raw_col_names <- colnames(fossil_ferns_raw)
fossils_categories <-
  tibble(raw_name = raw_col_names) %>%
  mutate(
    category = case_when(
      raw_name %in% raw_col_names[1:4] ~ "Calibration",
      raw_name %in% raw_col_names[5:12] ~ "Fossil Identity",
      raw_name %in% raw_col_names[13:18] ~ "Fossil Age",
      raw_name %in% raw_col_names[19:21] ~ "Fossil Locality",
      raw_name %in% raw_col_names[22:24] ~ "Fossil Specimen",
      TRUE ~ NA_character_
    )
  )

# Get list of fossils used
n_fos_used <-
  con_fossil_calibration_tips %>%
  filter(!is.na(n_fos)) %>%
  assert(is_uniq, n_fos) %>%
  select(n_fos)

# Tidy fossils in wide format
fossils <-
  fossil_ferns_all %>%
  # Filter to only those actually used in the study
  inner_join(
    n_fos_used, by = "n_fos"
  ) %>%
  verify(all(sort(.$n_fos) == sort(n_fos_used$n_fos))) %>%
  # Replace with formatted data
  select(
    -node_calibrated, -full_taxon_name, 
    -affinities, -notes_on_affinities, -notes_on_age) %>%
  left_join(fossil_notes, by = "n_fos") %>%
  # Put column names back in proper order
  select(all_of(colnames(fossil_ferns_all)))
```

```{r write-new-formatted, eval = FALSE}
# If needed, write out notes for further editing (if need to add new rows)
fossil_ferns_all %>%
  inner_join(
    n_fos_used, by = "n_fos"
  ) %>%
  anti_join(fossil_notes, by = "n_fos") %>%
  select(n_fos,
         node_calibrated, full_taxon_name, 
         affinities, notes_on_affinities, notes_on_age) %>%
  bind_rows(fossil_notes) %>%
  assert(is_uniq, n_fos) %>%
  arrange(n_fos) %>%
  write_csv(here::here("_targets/user/data_raw/fossils_used_formatted.csv"))
```

```{r format-for-printing}
# Make a tibble of column names for formatting
name_tbl <- tibble(
  raw_name = colnames(fossil_ferns_raw),
  var = colnames(fossil_ferns_all)
) %>%
  right_join(
    tibble(var = colnames(fossils)), by = "var"
  ) %>%
  mutate(var_order = 1:nrow(.))

# Convert to long format
fossils_long <- 
  fossils %>%
  mutate(
    across(everything(), as.character),
    fossil_taxon_header = fossil_taxon) %>%
  pivot_longer(names_to = "var", values_to = "value", -fossil_taxon) %>%
  left_join(name_tbl, by = "var") %>%
  mutate(
    text = as.character(glue::glue("{raw_name}: {value}"))
  ) %>%
  left_join(fossils_categories, by = "raw_name") %>%
  arrange(fossil_taxon, category, var_order) %>%
  # Drop NA entries
  filter(!is.na(value))
```

These data are exported from the FernCal v1.0 database (https://github.com/fernphy/ferncal), which includes `r nrow(fossil_ferns_raw)` records of fossils to use as calibration points for molecular dating of ferns.

"NFos" is the unique ID of the record in FernCal.

Taxonomy of extant taxa follows pteridocat v1.0 database (https://github.com/pteridophy/pteridocat).

For a summary of these data in CSV format, see `r s_table("fossils")`.

\newpage

```{r print-fossils, include = TRUE, results = "asis"}
taxa <- unique(fossils_long$fossil_taxon)

map(taxa, ~print_fossil(fossils_long, .)) %>%
  unlist() %>%
  glue::as_glue()
```

# References