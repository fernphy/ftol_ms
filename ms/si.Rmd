---
title: "Supplemental Information"
mainfont: Roboto-Regular.ttf
fontsize: 11pt
mainfontoptions: 
  - BoldFont=Roboto-Bold.ttf
  - ItalicFont=Roboto-Italic.ttf
  - BoldItalicFont=Roboto-BoldItalic.ttf
output: 
  bookdown::pdf_document2:
    citation_package: default
    toc: no
    number_sections: no
    fig_caption: yes
    keep_tex: no
    latex_engine: xelatex
    pandoc_args: [ "--csl", "frontiers.csl"]
header-includes: 
  - \usepackage{float} # keep figures from floating away
  - \usepackage{booktabs} # need for kable tables
  - \usepackage{colortbl} # need for kable tables
  - \makeatletter\renewcommand*{\fps@figure}{H}\makeatother # keep figures from floating away
  - \usepackage{fancyhdr} # enable header
  - \pagestyle{fancy}  # enable header
  - \fancypagestyle{plain}{\pagestyle{fancy}} # show header on first page
  - \renewcommand{\headrulewidth}{0pt} # delete line beneath header
  - \fancyhead[RE,RO]{Nitta \textit{et al}. Fern Tree of Life SI} # add header on right side
  - \fancyhead[LO,LE]{} # suppress automatic section header on left side
  - \cfoot{\thepage} # footer
editor_options: 
  chunk_output_type: console
params:
  doc_type: manual
---

---
bibliography: 
- `r here::here("ms/references.yaml")`
- `r here::here("ms/references_other.yaml")`
- `r here::here("ms/references_other.bib")`
---

```{r setup-si, include = FALSE}
knitr::opts_chunk$set(
	echo = FALSE, warning = FALSE, message = FALSE, results = 'hide')
# Load packages
library(ggupset)
library(kableExtra)
source(here::here("R/ms_packages.R"))
```

```{r load-functions-si, eval = params$doc_type == "manual"}
# Load functions (only if running interactively)
source(here::here("R/functions.R"))
```

```{r load-targets-si}
# Targets from FTOL workflow

# Specify path to FTOL cache
# FIXME: change to ftol_cache when ready
ftol_cache <- here::here("working/_targets")

tar_load(
	c(
		sanger_alignment_tbl,
		sanger_sampling,
		sanger_accessions_selection,
		plastome_tree,
		plastid_tree_dated),
	store = ftol_cache
)

# Targets from MS workflow
tar_load(
	c(
		gb_species_by_year,
		ref_files,
		other_dates,
		du_dates_all,
		family_stem_ages
	),
	store = here::here("_targets")
)
```

```{r load-captions, cache = FALSE}
# Source captions numbers from MS
# 
# So that caption numbers are in order of appearance in MS

# Run inline code when purling
options(knitr.purl.inline = TRUE)

# Make a temporary file to write out just inline R code from the SI Rmd
temp_file <- tempfile()

# Generate R script including inline R code from the ms Rmd
knitr::purl(here::here("ms/manuscript.Rmd"), output = temp_file)

# Trim this R script down to only functions that define figure and table captions
read_lines(temp_file) %>%
  magrittr::extract(
    str_detect(., "^figure\\(|^table\\(|^s_figure\\(|^s_table\\(|^figure_num\\(|^table_num\\(|^s_figure_num\\(|^s_table_num\\(")
  ) %>%
  unique %>%
  write_lines(temp_file)

# Source the code. This will load the caption functions in the right order.
source(temp_file, local = TRUE)

# Delete the temporary file
fs::file_delete(temp_file)
```

```{r join_by, results = "as-is"}
# Make table showing method of joining accessions across loci
sanger_accessions_selection %>% 
	left_join(select(sanger_sampling, species, outgroup), by = "species") %>%
	# FIXME why is this NA?
	# filter(is.na(outgroup)) %>%
	filter(outgroup == FALSE) %>%
	select(-outgroup) %>%
	assert(not_na, join_by, species) %>%
	assert(is_uniq, species) %>%
	tabyl(join_by) %>%
	arrange(n) %>%
	adorn_totals() %>%
	mutate(
		join_by = str_to_sentence(join_by) %>%
			str_replace_all("Monophy", "Monophyletic"),
		n = number(n),
		percent = case_when(
			join_by != "Total" ~ percent(percent) %>% 
				str_replace_all("%", "\\\\%"),
			TRUE ~ ""
		)
	) %>%
	rename(
		"Method" = join_by,
		`\\textit{n}` = n,
		`\\%` = percent
	) %>%
  kbl(booktabs = TRUE, escape = FALSE, format = "latex") %>%
  kable_styling(latex_options = c("striped", "HOLD_position"))
```

**`r s_table("join_by")`**. Methods used to join accessions across loci for Sanger dataset. Count is number of species.

\clearpage

```{r plot-prep-load}
# Load the plot prep code from the main MS
knitr::read_chunk(
	here::here("ms/manuscript.Rmd"),
	labels = "plot-prep-main",
	from = "og_taxa <-",
	to = "left_join\\(clade_cols_tib"
	)
```

<!-- Run the plot prep code -->
```{r, plot-prep-main}
```

```{r locus-upset, fig.width = 7, fig.height = 5}
# Make tibble with one row per locus per species
sanger_alignment_tbl %>%
	mutate(taxon = map(align_trimmed, rownames)) %>%
	select(locus = target, species = taxon) %>%
	unnest(cols = species) %>%
	# Exclude outgroups
	left_join(
		unique(select(sanger_sampling, species, outgroup)), by = "species") %>%
	filter(outgroup == FALSE) %>%
	select(-outgroup) %>%
	group_by(species) %>%
	summarize(locus = list(locus)) %>%
	ggplot(aes(x = locus)) +
	geom_bar() +
	labs(x = "Locus combination", y = "Count (num. species)") +
	scale_x_upset(n_intersections = 20)
```

**`r s_figure("locus-upset")`**.
Frequency of locus combinations by species, Sanger dataset.
Only top 20 combinations shown.

\clearpage

```{r du-ages, fig.width = 7, fig.height = 5}
# Helper function for subsetting dates to get into
# almost-long format
subset_ages <- function(other_dates, author_sel) {
	other_dates %>%
		select(family, contains(glue("{author_sel}_"))) %>%
		rename_with(~str_remove_all(., glue("{author_sel}_"))) %>%
		mutate(author = author_sel)
}

# Filter Du ages to just stem families
du_dates_stem_fam <-
	du_dates_all %>%
	filter(
		str_detect(affinities, "eae$"),
		affinities_group == "stem",
		str_detect(author, "^r")) %>%
	select(family = affinities, author, median, low, high)
	
# Make tibble of Du
du_schemes <- du_dates_stem_fam %>%
	select(scheme = author) %>%
	unique() %>%
	mutate(
		code = str_split(scheme, "_") %>%
			map_chr(last) %>%
			str_to_upper()) %>%
	arrange(code)

# Combine dates in almost-long format:
# one row per family/author combination,
# cols for median, high, and low date
all_ages_with_du <-
	bind_rows(
		du_dates_stem_fam,
		subset_ages(other_dates, "ts"),
		subset_ages(other_dates, "rothfels"),
		select(other_dates, family, median = schuettpelz_best) %>%
			mutate(author = "schuettpelz"),
		transmute(
			family_stem_ages,
			family,
			author = "current",
			median = age
		)
	) %>%
	filter(family %in% du_dates_stem_fam$family) %>%
	left_join(
		unique(select(sanger_sampling, family, major_clade)), by = "family") %>%
	left_join(clade_tibble, by = "major_clade") %>%
	# (some median dates are NA if that family wasn't included in a author)
	assert(not_na, family, major_clade, code, author) %>%
	# Set family as a factor ordered by current age estimate
	left_join(family_stem_ages, by = "family") %>%
	mutate(family = fct_reorder(family, age)) %>%
	select(-age)

# Define shapes and colors for points
du_ages_colors <- c(
	current = palette_okabe_ito(order = "vermillion"),
	rothfels = palette_okabe_ito(order = "bluishgreen"),
	schuettpelz = palette_okabe_ito(order = "blue"),
	ts = palette_okabe_ito(order = "orange"),
	rep(
		palette_okabe_ito(order = "gray"),
		length(du_schemes$scheme)) %>%
		set_names(du_schemes$scheme)
)

du_ages_shapes <- c(
	current = 16, # circle
	rothfels = 16,
	schuettpelz = 16,
	ts = 16,
	seq_along(du_schemes$scheme) %>%
		subtract(1) %>%
		set_names(du_schemes$scheme)
)

# Cross doesn't work because we can't distinguish error bars
du_ages_shapes[du_ages_shapes == 3] <- 6

# Format names of papers for printing
du_ages_sampling <-
	tribble(
		~source, ~year, ~label,
		"schuettpelz", 2009, "Schuettpelz & Pryer 2009",
		"rothfels", 2015, "Rothfels et al. 2015",
		"ts", 2016, "Testo and Sundue 2016",
		"current", 2021, "This study",
	) %>%
	bind_rows(
		du_schemes %>%
			mutate(
				year = 2020 + 0.1*seq_along(du_schemes$scheme),
				label = paste("Du et al. 2021 scheme", code)
			) %>%
			transmute(source = scheme, year, label)
	) %>%
	mutate(source = fct_reorder(source, year))


# Format y-axis text: show major clade in parentheses
family_labs_tbl <-
	all_ages_with_du %>%
	select(family, code) %>%
	unique() %>%
	mutate(label = glue("{family} ({code})"))

family_labs <- family_labs_tbl$label %>%
	set_names(., family_labs_tbl$family)

ggplot(all_ages_with_du) +
	geom_pointrange(
		aes(
			x = median, xmin = low, xmax = high,
			y = family,
			color = author, shape = author),
		position = position_dodge(width = 0.5)) +
	scale_shape_manual(
		values = du_ages_shapes,
		limits = du_ages_sampling$source, 
		labels = du_ages_sampling$label) +
	scale_color_manual(
		values = du_ages_colors,
		limits = du_ages_sampling$source, 
		labels = du_ages_sampling$label) +
	scale_y_discrete(labels = family_labs, expand = expansion(add = 0.7)) +
	scale_x_reverse("Age (millions of years)") +
	coord_geo(
		dat = list("periods", "eras"),
		pos = list("b", "b"),
		abbrv = list(TRUE, FALSE),
		xlim = c(250, 0),
		fill = "transparent",
		color = "grey20",
		lab_color = "grey30",
		height = unit(1, "lines"),
		# FIXME: change this to true when issue gets resolved
		# https://github.com/willgearty/deeptime/issues/41
		expand = FALSE,
		size = 3) +
	theme_bw() +
	theme(
		axis.title.y = element_blank(),
		legend.title = element_blank()
	)
```

**`r s_figure("du-ages")`**.
Stem age of fern families (Ma) estimated by selected studies, only including families that were sampled across all studies.
For studies that used methods with confidence intervals, error bars indicate lower and upper 95% highest posterior density levels and point indicates median [@Rothfels2015a; @Testo2016a; @Du2021].
For other studies, point indicates best (most likely) estimate [@Schuettpelz2007b\; this study].
@Du2021 used six different dating schemes; for details, see that paper.
Codes in parentheses after family names indicate major clade as in `r figure("ftol")`.
Period name abbreviations as follows: FIXME.
